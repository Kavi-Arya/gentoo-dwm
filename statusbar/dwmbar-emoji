#!/bin/sh

# Battery :
bat(){
	for battery in /sys/class/power_supply/BAT?*; do
		# If non-first battery, print a space separator.
		[ -n "${capacity+x}" ] && printf " "
		# Sets up the status and capacity
		case "$(cat "$battery/status" 2>&1)" in
			"Full") status="âš¡" ;;
			"Discharging") status="ðŸ”‹" ;;
			"Charging") status="ðŸ”Œ" ;;
			"Not charging") status="ðŸ›‘" ;;
			"Unknown") status="â™»ï¸" ;;
			*) exit 1 ;;
		esac
		capacity="$(cat "$battery/capacity" 2>&1)"
		# Will make a warn variable if discharging and low
		[ "$status" = "ðŸ”‹" ] && [ "$capacity" -le 25 ] && warn="â—"
		# Prints the info
		printf "%s%s%d%%" "$status" "$warn" "$capacity"; unset warn
	done && printf "\\n"
}

# Date && clock :
dat(){
	clock=$(date '+%I')
	case "$clock" in
		"00") icon="ðŸ•›" ;;
		"01") icon="ðŸ•" ;;
		"02") icon="ðŸ•‘" ;;
		"03") icon="ðŸ•’" ;;
		"04") icon="ðŸ•“" ;;
		"05") icon="ðŸ•”" ;;
		"06") icon="ðŸ••" ;;
		"07") icon="ðŸ•–" ;;
		"08") icon="ðŸ•—" ;;
		"09") icon="ðŸ•˜" ;;
		"10") icon="ðŸ•™" ;;
		"11") icon="ðŸ•š" ;;
		"12") icon="ðŸ•›" ;;
	esac
	date "+ðŸ“…%a %d %b %Y|$icon%I:%M%p"
}

# Cpu Temp :
tmp(){
	sensors | awk '/Core 0/ {print "ðŸŒ¡" $3}'
}

# Cpu Usage :
cpu(){
	cpu=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{printf "%02.1f%%" , 100 - $1}') 
	echo -e "ðŸ’»$cpu"
}

# Keybord Layout :
key(){
	kb="$(xkb-switch)" || exit 1
	echo "ðŸ”¤$kb"
}

# Screen Light :
lit(){
	#lit="$(xbacklight | sed 's/\..*//g')"
	#echo "ðŸ’¡$lit%"
	lit="$(brightnessctl | grep -oP '[^()]+%')"
	echo "ðŸ’¡$lit"	
}

# Memory :
mem(){
	free --mebi | sed -n '2{p;q}' | awk '{printf ("ðŸ§ %2.2fGiB/%2.2fGiB\n", ( $3 / 1024), ($2 / 1024))}'	
}

# Volume :
vol(){
	[ $(pamixer --get-mute) = true ] && echo ðŸ”‡ && exit

	vol="$(pamixer --get-volume)"

	if [ "$vol" -gt "70" ]; then
		icon="ðŸ”Š"
	elif [ "$vol" -gt "30" ]; then
		icon="ðŸ”‰"
	elif [ "$vol" -gt "0" ]; then
		icon="ðŸ”ˆ"
	else
		echo ðŸ”‡ && exit
	fi
	echo "$icon$vol%"
}
net(){
	if grep -xq 'up' /sys/class/net/w*/operstate 2>/dev/null ; then
		wifiicon="$(awk '/^\s*w/ { print "ðŸ“¶", int($3 * 100 / 70) "% " }' /proc/net/wireless)"
	elif grep -xq 'down' /sys/class/net/w*/operstate 2>/dev/null ; then
		grep -xq '0x1003' /sys/class/net/w*/flags && wifiicon="ðŸ“¡ " || wifiicon="âŒ "
	fi

	printf "%s%s%s\n" "$wifiicon" "$(sed "s/down/âŽ/;s/up/ðŸŒ/" /sys/class/net/e*/operstate 2>/dev/null)" "$(sed "s/.*/ðŸ”’/" /sys/class/net/tun*/operstate 2>/dev/null)"
}
nettrf(){
	
	update() {
		sum=0
		for arg; do
			read -r i < "$arg"
			sum=$(( sum + i ))
		done
		cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
		[ -f "$cache" ] && read -r old < "$cache" || old=0
		printf %d\\n "$sum" > "$cache"
		printf %d\\n $(( sum - old ))
	}

	rx=$(update /sys/class/net/[ew]*/statistics/rx_bytes)
	tx=$(update /sys/class/net/[ew]*/statistics/tx_bytes)

	printf "ðŸ”»%4sB ðŸ”º%4sB\\n" $(numfmt --to=iec $rx) $(numfmt --to=iec $tx)	
}

while true; do
  xsetroot -name "|$(nettrf)|$(net)|$(tmp)|$(cpu)|$(mem)|$(vol)|$(lit)|$(bat)|$(key)|$(dat) |"
  sleep 0.2
done &
